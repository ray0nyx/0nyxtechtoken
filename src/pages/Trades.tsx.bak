import { useEffect, useState } from "react";
import { Link } from "react-router-dom";
import { createClient } from "@/lib/supabase/client";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { PlusCircle } from "lucide-react";
import { Loading } from "@/components/ui/loading";
import { SharePnLImage } from "@/components/trades/SharePnLImage";
import { format } from "date-fns";

interface Trade {
  id: string;
  symbol: string;
  entry_price: number;
  exit_price: number;
  quantity: number;
  entry_date: string;
  exit_date: string;
  pnl: number;
  position: string;
  strategy?: string;
  broker?: string;
}

export default function Trades() {
  const [trades, setTrades] = useState<Trade[]>([]);
  const [loading, setLoading] = useState(true);
  const [dailyPnL, setDailyPnL] = useState(0);
  const supabase = createClient();

  useEffect(() => {
    const fetchTrades = async () => {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error("No authenticated user");

        const { data, error } = await supabase
          .from("trades")
          .select("*")
          .eq("user_id", user.id)
          .order("entry_date", { ascending: false });

        if (error) throw error;
        setTrades(data || []);
        
        // Calculate today's P&L
        calculateDailyPnL(data || []);
      } catch (error) {
        console.error("Error fetching trades:", error);
      } finally {
        setLoading(false);
      }
    };

    fetchTrades();
  }, []);
  
  const calculateDailyPnL = (trades: Trade[]) => {
    const today = format(new Date(), 'yyyy-MM-dd');
    
    // Filter trades for today
    const todayTrades = trades.filter(trade => {
      const tradeDate = format(new Date(trade.exit_date || trade.entry_date), 'yyyy-MM-dd');
      return tradeDate === today;
    });
    
    // Sum up the P&L
    const totalPnL = todayTrades.reduce((sum, trade) => sum + (trade.pnl || 0), 0);
    setDailyPnL(totalPnL);
  };

  if (loading) {
    return <Loading />;
  }

  return (
    <div className="container py-6">
      <div className="mb-6 flex items-center justify-between">
        <h1 className="text-3xl font-bold">Trade Log</h1>
        <div className="flex gap-2">
          <SharePnLImage dailyPnL={dailyPnL} />
          <Link to="/app/trades/add">
            <Button className="flex items-center gap-2">
              <PlusCircle className="h-4 w-4" />
              Add Trade
            </Button>
          </Link>
        </div>
      </div>

      <div className="grid gap-4">
        {trades.length === 0 ? (
          <Card>
            <CardContent className="flex flex-col items-center justify-center py-8">
              <p className="mb-4 text-center text-muted-foreground">
                No trades recorded yet. Start by adding your first trade!
              </p>
              <Link to="/app/trades/add">
                <Button className="flex items-center gap-2">
                  <PlusCircle className="h-4 w-4" />
                  Add Trade
                </Button>
              </Link>
            </CardContent>
          </Card>
        ) : (
          trades.map((trade) => (
            <Card key={trade.id}>
              <CardHeader>
                <CardTitle className="flex items-center justify-between">
                  <span>{trade.symbol}</span>
                  <span
                    className={`text-sm ${
                      trade.pnl >= 0 ? "text-green-500" : "text-red-500"
                    }`}
                  >
                    {trade.pnl >= 0 ? "+" : ""}${trade.pnl.toFixed(2)}
                  </span>
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-2 gap-4 text-sm">
                  <div>
                    <p className="text-muted-foreground">Entry</p>
                    <p>
                      ${trade.entry_price.toFixed(2)} Ã— {trade.quantity}
                    </p>
                    <p className="text-muted-foreground">
                      {new Date(trade.entry_date).toLocaleDateString()}
                    </p>
                  </div>
                  <div>
                    <p className="text-muted-foreground">Exit</p>
                    <p>${trade.exit_price.toFixed(2)}</p>
                    <p className="text-muted-foreground">
                      {new Date(trade.exit_date).toLocaleDateString()}
                    </p>
                  </div>
                  {trade.strategy && (
                    <div>
                      <p className="text-muted-foreground">Strategy</p>
                      <p>{trade.strategy}</p>
                    </div>
                  )}
                  {trade.broker && (
                    <div>
                      <p className="text-muted-foreground">Broker</p>
                      <p>{trade.broker}</p>
                    </div>
                  )}
                </div>
              </CardContent>
            </Card>
          ))
        )}
      </div>
    </div>
  );
} 